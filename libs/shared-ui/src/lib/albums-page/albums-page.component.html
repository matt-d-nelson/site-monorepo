<core-ui-page-wrapper
  title="music"
  addLabel="Add Album"
  [userIsAdmin]="userIsAdmin()"
  (onAdd)="initAlbumDraft()"
>
  <!-- draft albums -->
  <div *ngIf="userIsAdmin()">
    <div *ngFor="let draft of draftAlbums()">
      <ng-container
        [ngTemplateOutlet]="albumCard"
        [ngTemplateOutletContext]="{ album: draft }"
      >
      </ng-container>
    </div>
  </div>
  <div *ngFor="let album of publishedAlbums()">
    <ng-container
      [ngTemplateOutlet]="albumCard"
      [ngTemplateOutletContext]="{ album: album }"
    >
    </ng-container>
  </div>
</core-ui-page-wrapper>

<!-- album template -->
<ng-template #albumCard let-album="album">
  <div class="album-wrapper p-4 mx-auto rounded-2xl my-10">
    <div class="grid grid-cols-2 gap-4">
      <div class="aspect-square overflow-hidden rounded-2xl">
        <core-ui-lazy-img [source]="album?.coverArtUrl"></core-ui-lazy-img>
      </div>
      <div class="flex flex-col aspect-square overflow-hidden">
        <div class="border-b-2 flex justify-between items-center py-1">
          <h2 class="px-2 text-xl">{{ album?.name ?? 'unnamed draft' }}</h2>
          <div *ngIf="userIsAdmin()" class="flex justify-end">
            <core-ui-button
              [type]="BUTTON_TYPES().OUTLINE"
              [color]="CORE_COLORS().DANGER"
              label="Delete"
              (onClick)="deleteAlbumClick(album)"
            ></core-ui-button>
            <!-- <core-ui-button
            [type]="BUTTON_TYPES().OUTLINE"
            label="Edit"
            (onClick)="editEventClick(event)"
            class="ml-2"
          ></core-ui-button> -->
          </div>
        </div>
        <div class="grow overflow-hidden">
          <ng-scrollbar>
            <p class="text-xs md:text-base p-2 whitespace-pre-wrap">
              {{ album?.description }}
            </p>
          </ng-scrollbar>
        </div>
      </div>
      <div class="col-span-2 border-t-2">
        <div *ngFor="let track of album?.tracks">
          <div class="flex items-center">
            <core-ui-play-button [id]="track.id"></core-ui-play-button>
            <p class="mr-2">{{ track?.trackPlacement }}.</p>
            <p>{{ track?.name }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- add album dialog -->
<!-- TODO: create a dialog component to share with form dialog -->
<dialog
  #albumFormDialog
  class="p-6 dialog-body h-full overflow-hidden md:min-w-96"
>
  <div class="flex flex-col h-full">
    <h1 class="text-xl border-b-2">Add Album</h1>
    <ng-scrollbar class="h-full">
      <div class="p-4">
        <form [formGroup]="albumForm" class="grid gap-2">
          <core-ui-img-input
            class="mb-2"
            [control]="albumForm.get('coverArt')"
            [parentForm]="albumForm"
          >
          </core-ui-img-input>
          <core-ui-input
            label="Title"
            type="text"
            [control]="albumForm.get('name')"
            [parentForm]="albumForm"
          >
          </core-ui-input>
          <core-ui-input
            label="Release Date"
            type="date"
            [control]="albumForm.get('releaseDate')"
            [parentForm]="albumForm"
          >
          </core-ui-input>
          <core-ui-input
            label="Description"
            type="textarea"
            [control]="albumForm.get('description')"
            [parentForm]="albumForm"
          >
          </core-ui-input>
        </form>
        <!-- added tracks -->
        <h2 class="mb-3 text-xl border-b-2">Tracks</h2>
        <div class="mx-2">
          <div class="flex my-2" *ngFor="let track of draftAlbumTracks()">
            <div class="draft-track-wrapper flex items-center w-full px-4 mr-2">
              <p class="mr-2">{{ track.trackPlacement }}:</p>
              <p>{{ track.name }}</p>
            </div>
            <core-ui-button
              label="Delete"
              (onClick)="deleteTrack(track)"
              [type]="BUTTON_TYPES().OUTLINE"
              [color]="CORE_COLORS().DANGER"
              [loading]="dialogLoading()"
            ></core-ui-button>
          </div>
        </div>
        <!-- add track form -->
        <h2 class="mb-3 text-xl border-b-2">Add Track</h2>
        <div class="mx-2">
          <form [formGroup]="trackForm" class="grid gap-2">
            <core-ui-file-input
              label="Audio file"
              type="file"
              [control]="trackForm.get('file')"
              [parentForm]="trackForm"
              [loading]="dialogLoading()"
              [acceptedFiles]="['wav', 'mp3']"
            ></core-ui-file-input>
            <core-ui-input
              label="Title"
              type="text"
              [control]="trackForm.get('name')"
              [parentForm]="trackForm"
            >
            </core-ui-input>
            <core-ui-input
              label="Track Number"
              type="number"
              [control]="trackForm.get('trackPlacement')"
              [parentForm]="trackForm"
            >
            </core-ui-input>
            <core-ui-input
              label="Lyrics"
              type="textarea"
              [control]="trackForm.get('lyrics')"
              [parentForm]="trackForm"
            >
            </core-ui-input>
          </form>
          <div class="flex justify-end">
            <core-ui-button
              label="Add Track"
              (onClick)="createTrack()"
              [type]="BUTTON_TYPES().OUTLINE"
              [loading]="dialogLoading()"
              class="ml-3"
            ></core-ui-button>
          </div>
        </div>
      </div>
    </ng-scrollbar>
    <div class="flex justify-end pt-2 border-t-2">
      <core-ui-button
        label="Cancel"
        (onClick)="cancelAlbumDraft()"
        [type]="BUTTON_TYPES().OUTLINE"
        [color]="CORE_COLORS().DANGER"
        [loading]="dialogLoading()"
      ></core-ui-button>
      <core-ui-button
        label="Publish Album"
        (onClick)="publishAlbumDraft()"
        [type]="BUTTON_TYPES().OUTLINE"
        [loading]="dialogLoading()"
        class="ml-3"
      ></core-ui-button>
    </div>
  </div>
</dialog>
